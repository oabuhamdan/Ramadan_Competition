{% extends 'base.html' %}
{% block custom_head %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/users.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.0.2/chart.min.js"></script>

{% endblock %}
{% load crispy_forms_filters %}

{% block title %}
    تفاصيل نتائج المستخدم
{% endblock %}
{% load crispy_forms_tags %}

{% block page_header %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismiss" role="alert">
            {{ message|safe }}
        </div>
    {% endfor %}
    <div>
        <h2>
            صفحة تفاصيل نتائج المستخدم {{ data.user.first_name }}
        </h2>
        <hr>
    </div>
{% endblock %}
{% block content %}

    <div id="accordion" class="rtl-style">
        <div class="card">
            <!-- Card header -->
            <div class="card-header" role="tab" id="heading">
                <a class="details-collapse" data-toggle="collapse" data-parent="#accordionEx"
                   href="#collapse{{ forloop.counter }}"
                   aria-expanded="true"
                   aria-controls="collapse{{ forloop.counter }}">
                    <h5 class="mb-0" style="float: right">
                        رسم بياني للنقاط
                    </h5>
                    <h6 style="float: left">
                        المجموع الكلي: {{ data.user.total_points|floatformat:"-2" }}
                    </h6>
                </a>
            </div>
            <!-- Card body -->
            <div id="collapse{{ forloop.counter }}" class="collapse show" role="tabpanel"
                 aria-labelledby="heading{{ forloop.counter }}"
                 data-parent="#accordionEx">
                <div class="card-body">
                    <canvas id="myChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
        {% for date, points in data.points.items %}
            <!-- Accordion card -->
            <div class="card">
                <!-- Card header -->
                <div class="card-header" role="tab" id="heading">
                    <a class="details-collapse" data-toggle="collapse" data-parent="#accordionEx"
                       href="#collapse{{ forloop.counter }}"
                       aria-expanded="true"
                       aria-controls="collapse{{ forloop.counter }}">
                        <h5 class="mb-0" style="float: right">
                            نتائج يوم {{ date }} رمضان<i class="fas fa-angle-down rotate-icon"></i>
                        </h5>
                        <h6 style="float: left">
                            المجموع اليومي:<span
                                class="total_day">{{ data.total_daily|get_item:date |floatformat:"-2" }}</span>
                        </h6>
                    </a>
                </div>
                <!-- Card body -->
                <div id="collapse{{ forloop.counter }}" class="collapse show" role="tabpanel"
                     aria-labelledby="heading{{ forloop.counter }}"
                     data-parent="#accordionEx">
                    <div class="card-body">
                        <table class="table table-hover table-borderless text-center">
                            <thead>
                            <tr>
                                <th scope="col">العمل</th>
                                <th scope="col">النقاط</th>
                                <th scope="col">تفاصيل</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for point in points %}
                                <tr>
                                    <td>{{ point.type.label }}</td>
                                    <td>{{ point.value|floatformat:"-2" }}</td>
                                    <td>{{ point.details }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Accordion card -->
        {% endfor %}
    </div>
    <script>
        items_to_view = Math.ceil(window.screen.width / 100);
        d = []
        $('.total_day').each(function () {
            var t = $(this).text();
            d.push(t)
        })
        d.reverse()
        labels = []
        for (let i = Math.max(1, d.length - items_to_view - 1); i <= d.length; i++) {
            labels.push("رمضان - " + i)
        }
        d = d.slice(-items_to_view);
        const data = {
            labels: labels,
            datasets: [{
                label: 'النقاط',
                data: d,
                fill: false,
                borderColor: 'rgb(0,191,255)',
            }]
        };
        var ctx = document.getElementById('myChart').getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
{% endblock %}